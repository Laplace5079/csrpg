# 《墨境：孤军》(Ink Realm: Lone Army)
## 全局文件依赖树及 5 小时流程时间线规划

---

## 一、项目架构总览

### 1.1 技术栈
```
┌─────────────────────────────────────────────────────────────────┐
│                        构建层 (Vite)                             │
├─────────────────────────────────────────────────────────────────┤
│  TypeScript → Minified JS → WebGL 2.0 + Rapier.js             │
└─────────────────────────────────────────────────────────────────┘
```

### 1.2 核心依赖关系
```
┌─────────────────────────────────────────────────────────────────┐
│                        入口点 (main.ts)                          │
├─────────────────────────────────────────────────────────────────┤
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐        │
│  │  Core.ts     │  │  UIManager  │  │  AssetLoader │        │
│  │  (全局总线)   │  │  (UI管理)   │  │  (资源加载)  │        │
│  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘        │
│         │                 │                  │                  │
│  ┌──────┴────────────────┴──────────────────┴────────┐        │
│  │              Systems Layer (系统层)                 │        │
│  ├──────────────┬──────────────┬──────────────┬───────┤        │
│  │ Player.ts   │ AIManager.ts │ LevelManager│ NPCMgr │        │
│  │ (FPS控制)   │ (AI调度)     │ (关卡管理)  │ (NPC)  │        │
│  └──────┬───────┴──────┬───────┴──────┬───────┴───────┘        │
│         │              │              │                        │
│  ┌──────┴──────────────┴──────────────┴───────────────┐       │
│  │              Engine Layer (引擎层)                    │       │
│  ├──────────────┬──────────────┬──────────────┬────────┤       │
│  │ Renderer.ts │ PhysicsWorld │ InputManager │ Audio  │       │
│  │ (渲染)       │ (物理)       │ (输入)       │ (音频)  │       │
│  └──────────────┴──────────────┴──────────────┴────────┘       │
│                                                                 │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │              Data Layer (数据层)                          │  │
│  ├─────────────┬─────────────┬─────────────┬───────────────┤  │
│  │ levels.json │ npcs.json   │ items.json  │ dialogue.json │  │
│  └─────────────┴─────────────┴─────────────┴───────────────┘  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 二、全局文件依赖树

### 2.1 目录结构
```
ink-realm-lone-army/
├── src/
│   ├── main.ts                    # 入口点
│   │
│   ├── core/                      # 核心层 (全局总线)
│   │   ├── Core.ts                # 游戏状态管理 + 数据总线
│   │   ├── GameState.ts           # 状态机定义
│   │   ├── SaveSystem.ts          # 存档/读取
│   │   ├── EventBus.ts            # 事件总线
│   │   └── constants.ts           # 全局常量
│   │
│   ├── engine/                    # 引擎层
│   │   ├── Renderer.ts            # WebGL 2.0 渲染器
│   │   ├── PhysicsWorld.ts        # Rapier.js 物理世界
│   │   ├── InputManager.ts        # 输入管理 (键盘/鼠标)
│   │   ├── AudioManager.ts        # 音频管理
│   │   ├── AssetLoader.ts         # 资源加载器
│   │   ├── ShaderManager.ts       # Shader 管理
│   │   └── ObjectPool.ts          # 对象池 (子弹/粒子)
│   │
│   ├── systems/                   # 系统层
│   │   ├── player/
│   │   │   ├── Player.ts          # 玩家控制器
│   │   │   ├── WeaponSystem.ts    # 武器系统
│   │   │   ├── Movement.ts        # 移动/跳跃
│   │   │   └── CameraShake.ts     # 摄像机震动
│   │   │
│   │   ├── ai/
│   │   │   ├── AIManager.ts       # AI 调度器 (Time-slicing)
│   │   │   ├── Perception.ts      # 感知系统 (视觉/听觉)
│   │   │   ├── CoverSystem.ts     # 掩体系统
│   │   │   ├── BehaviorTree.ts    # 行为树执行器
│   │   │   ├── EnemyFactory.ts    # 敌人工厂
│   │   │   ├── enemies/
│   │   │   │   ├── BaseEnemy.ts   # 基础敌人
│   │   │   │   ├── Grunt.ts       # 杂兵
│   │   │   │   ├── Soldier.ts     # 战术士兵
│   │   │   │   └── Elite.ts       # 精英敌人
│   │   │   └── boss/
│   │   │       ├── BossBase.ts    # BOSS 基类
│   │   │       ├── BossArm.ts     # 巨型机械臂
│   │   │       ├── BossGhost.ts   # 幽灵刺客
│   │   │       └── BossVoid.ts    # 虚空吞噬者
│   │   │
│   │   ├── level/
│   │   │   ├── LevelManager.ts    # 关卡管理器
│   │   │   ├── WaveManager.ts     # 波次管理
│   │   │   ├── SpawnSystem.ts     # 生成系统
│   │   │   └── Checkpoint.ts      # 检查点
│   │   │
│   │   ├── rpg/
│   │   │   ├── PlayerStats.ts     # 玩家属性
│   │   │   ├── LevelSystem.ts     # 等级系统
│   │   │   ├── SkillTree.ts       # 技能树
│   │   │   ├── DamageCalc.ts      # 伤害计算
│   │   │   ├── Equipment.ts       # 装备系统
│   │   │   ├── Inventory.ts       # 物品栏
│   │   │   └── DropSystem.ts      # 掉落系统
│   │   │
│   │   ├── npc/
│   │   │   ├── NPCManager.ts      # NPC 管理器
│   │   │   ├── DialogueSystem.ts  # 对话系统
│   │   │   ├── QuestSystem.ts     # 任务系统
│   │   │   └── NPC.ts             # NPC 实体
│   │   │
│   │   └── ui/
│   │       ├── UIManager.ts       # UI 管理器
│   │       ├── HUD.ts             # 主 HUD
│   │       ├── Minimap.ts         # 小地图
│   │       ├── HealthBar.ts       # 血条
│   │       ├── DamageNumbers.ts   # 伤害飘字
│   │       ├── QuestTracker.ts    # 任务追踪
│   │       ├── InventoryUI.ts     # 物品栏 UI
│   │       └── PauseMenu.ts       # 暂停菜单
│   │
│   ├── data/                      # 数据层 (JSON)
│   │   ├── levels.json            # 关卡配置
│   │   ├── enemies.json           # 敌人配置
│   │   ├── weapons.json           # 武器配置
│   │   ├── items.json             # 物品配置
│   │   ├── npcs.json              # NPC 配置
│   │   ├── skills.json            # 技能配置
│   │   ├── dialogue.json          # 对话脚本
│   │   └── quests.json            # 任务配置
│   │
│   ├── shaders/                   # 自定义 Shader
│   │   ├── neon.glsl              # 霓虹边缘光
│   │   ├── scanline.glsl         # 扫描线
│   │   ├── glitch.glsl            # 故障效果
│   │   └── vignette.glsl          # 暗角
│   │
│   └── utils/
│       ├── math.ts                # 数学工具
│       ├── time.ts                # 时间工具
│       └── debug.ts               # 调试工具
│
├── public/
│   └── assets/
│       ├── models/                # 3D 模型
│       ├── textures/              # 纹理
│       ├── audio/                 # 音效
│       └── fonts/                 # 字体
│
├── package.json
├── tsconfig.json
├── vite.config.ts
└── index.html
```

### 2.2 依赖导入关系图
```
main.ts
├── Core.ts
│   ├── GameState.ts
│   ├── SaveSystem.ts
│   └── EventBus.ts
│
├── AssetLoader.ts
│   └── (加载资源)
│
├── UIManager.ts
│   ├── HUD.ts
│   ├── Minimap.ts
│   ├── DamageNumbers.ts
│   ├── QuestTracker.ts
│   └── InventoryUI.ts
│
├── Renderer.ts
│   ├── ShaderManager.ts
│   └── ObjectPool.ts
│
├── PhysicsWorld.ts
│
├── Player.ts
│   ├── WeaponSystem.ts
│   ├── Movement.ts
│   ├── CameraShake.ts
│   └── PlayerStats.ts (RPG)
│
├── AIManager.ts
│   ├── Perception.ts
│   ├── CoverSystem.ts
│   ├── BehaviorTree.ts
│   └── EnemyFactory.ts
│       ├── BaseEnemy.ts
│       │   └── Grunt.ts / Soldier.ts / Elite.ts
│       └── BossBase.ts
│           └── BossArm.ts / BossGhost.ts / BossVoid.ts
│
├── LevelManager.ts
│   ├── WaveManager.ts
│   ├── SpawnSystem.ts
│   └── Checkpoint.ts
│
├── NPCManager.ts
│   ├── DialogueSystem.ts
│   └── QuestSystem.ts
│
└── (LevelManager → 加载 levels.json)
(NPCManager → 加载 npcs.json, dialogue.json, quests.json)
(WeaponSystem → 加载 weapons.json)
(DropSystem → 加载 items.json)
```

---

## 三、5 小时流程时间线规划

### 3.1 章节分布

| 章节 | 名称 | 流程时长 | 核心玩法 | BOSS |
|------|------|---------|---------|------|
| **Ch.0** | 新兵训练 | 15min | 移动/射击教学 | 无 |
| **Ch.1** | 机械觉醒 | 50min | 潜行 + 掩体 | 巨型机械臂 |
| **Ch.2** | 灰色地带 | 60min | 战术小队围剿 | 幽灵刺客 |
| **Ch.3** | 超凡领域 | 70min | 多阶段 BOSS 战 | 虚空吞噬者 |
| **Ch.4** | 核心入侵 | 60min | 解谜 + 混合战斗 | 量子核心 |
| **Ch.5** | 终末之战 | 65min | 连续 BOSS 战 | 最终形态 |
| **总计** | | **320min ≈ 5.3h** | | |

### 3.2 详细时间线

```
┌─────────────────────────────────────────────────────────────────┐
│  Ch.0 新兵训练 (15 min)                                         │
├─────────────────────────────────────────────────────────────────┤
│  0:00 - 3:00   教程: WASD 移动                                  │
│  3:00 - 6:00   教程: 鼠标瞄准 + 左键射击                        │
│  6:00 - 9:00   教程: 空格跳跃                                   │
│  9:00 - 12:00  教程: 换弹 (R)                                  │
│  12:00 - 15:00 教程: 击杀 3 个训练机器人 → 通往 Ch.1           │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│  Ch.1 机械觉醒 (50 min)                                         │
├─────────────────────────────────────────────────────────────────┤
│  0:00 - 10:00  剧情: 抵达前哨基地                               │
│  10:00 - 20:00 任务: 寻找入口 (小地图教学)                      │
│  20:00 - 30:00 战斗: 遭遇 5 波巡逻机器人                       │
│  30:00 - 40:00 战斗: 精英机器人 + 潜行绕过                      │
│  40:00 - 50:00 BOSS: 巨型机械臂 (3 阶段)                       │
│                 机制: 抓取 → 激光扫射 → 锤击                     │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│  Ch.2 灰色地带 (60 min)                                         │
├─────────────────────────────────────────────────────────────────┤
│  0:00 - 10:00  剧情: 进入废弃工业区                             │
│  10:20 - 20:00 任务: 修复信号塔                                 │
│  20:00 - 35:00 战斗: 遭遇战术小队 (掩体系统教学)                 │
│  35:00 - 45:00 战斗: 围攻模式 (多路敌人)                        │
│  45:00 - 60:00 BOSS: 幽灵刺客 (3 阶段)                         │
│                 机制: 隐形 → 瞬移 → 分身                         │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│  Ch.3 超凡领域 (70 min)                                         │
├─────────────────────────────────────────────────────────────────┤
│  0:00 - 15:00  剧情: 进入神秘领域                               │
│  15:00 - 30:00 任务: 收集 3 个能量碎片                         │
│  30:00 - 45:00 战斗: 超凡者敌人 (高 AI)                        │
│  45:00 - 55:00 战斗: 召唤小怪 + 技能教学                       │
│  55:00 - 70:00 BOSS: 虚空吞噬者 (5 阶段)                       │
│                 机制: 虚影 → 实体 → 狂暴 → 传送 → 虚空炮        │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│  Ch.4 核心入侵 (60 min)                                         │
├─────────────────────────────────────────────────────────────────┤
│  0:00 - 15:00  剧情: 抵达量子核心                               │
│  15:00 - 30:00 任务: 破解 3 道密码门 (解谜)                    │
│  30:00 - 45:00 战斗: 混合部队 (机器人 + 士兵)                   │
│  45:00 - 60:00 BOSS: 量子核心 (3 阶段)                         │
│                 机制: 防护罩 → 脉冲 → 自毁                      │
└─────────────────────────────────────────────────────────────────┘
                              ↓
┌─────────────────────────────────────────────────────────────────┐
│  Ch.5 终末之战 (65 min)                                         │
├─────────────────────────────────────────────────────────────────┤
│  0:00 - 15:00  剧情: 最终抉择                                   │
│  15:00 - 30:00 战斗: 无尽精英模式 (生存)                       │
│  30:00 - 45:00 BOSS1: 巨型机甲                                 │
│  45:00 - 55:00 BOSS2: 黑暗法师                                 │
│  55:00 - 65:00 BOSS3: 最终形态 (最终决战)                      │
│                 结局: 通关 → 结算画面                            │
└─────────────────────────────────────────────────────────────────┘
```

---

## 四、开发里程碑

### Phase 1: 内核与数据协议 (Week 1-2)
- [ ] Vite + TypeScript 环境
- [ ] WebGL 2.0 渲染器配置
- [ ] Core.ts (状态管理 + 存档)
- [ ] JSON Schema 规范

### Phase 2: FPS 交互与渲染 (Week 3-4)
- [ ] Player.ts (PointerLock + 物理)
- [ ] WeaponSystem.ts (射击 + 后坐力)
- [ ] GPU 实例化渲染
- [ ] 对象池优化

### Phase 3: 智能 PVE 与 AI (Week 5-6)
- [ ] AIManager.ts (Time-slicing)
- [ ] 感知系统 (视觉/听觉)
- [ ] 掩体系统
- [ ] 行为树执行器
- [ ] NPC 对话系统

### Phase 4: UI 与导航 (Week 7-8)
- [ ] UIManager.ts
- [ ] 小地图 (雷达映射)
- [ ] 血条/伤害飘字
- [ ] 任务追踪器

### Phase 5: 内容生成 (Week 9-10)
- [ ] Ch.1-Ch.3 JSON 脚本
- [ ] BOSS 行为配置
- [ ] 完整测试
- [ ] 性能优化 (5 小时长流程)

---

## 五、验证检查点

- [ ] Core.ts 数据总线正常运行
- [ ] 存档/读档功能正常
- [ ] 60fps 稳定 (50+ 敌人)
- [ ] AI 感知/掩体/包抄正常工作
- [ ] NPC 对话分支正常
- [ ] 小地图正确映射
- [ ] Ch.1 关卡完整可玩
- [ ] BOSS 多阶段转换正常

---

**确认此规划后，我即刻启动第一阶段：初始化 Vite + WebGL 2.0 + Core.ts 全局数据总线**
